<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta name="baidu-site-verification" content="codeva-NSg7ynviLa" />
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    R包-sommer |  
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/images/mojie.jpg" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  
<link rel="stylesheet" href="/css/custom.css">

  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

<link rel="alternate" href="/atom.xml" title="null" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-R包-sommer"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  R包-sommer
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/posts/16585429/" class="article-date">
  <time datetime="2023-12-13T08:30:02.000Z" itemprop="datePublished">2023-12-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a> / <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/R/">R</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">3k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">12 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>sommer 包可以进行 GBLUP 或 RRBLUP  分析，不过只能用于小规模数据。</p>
<span id="more"></span>
<h1>sommer 包功能和注意事项</h1>
<ul>
<li>
<p>sommer 包是通过对 V 矩阵(mmer函数) 或 系数矩阵(mmec函数) 直接求逆从而求解 MME 的 R包，因为需要直接求逆，直接求逆的矩阵维度最好小于10000。</p>
<p>通过实际测试，当矩阵维度超过 1万时，sommer 计算速度非常慢，几乎卡死。</p>
</li>
<li>
<p>表型不能有缺失，sommer 的表型缺失填充使用中位数，有点怪异，默认会剔除含缺失的表型行。</p>
</li>
<li>
<p>支持计算显性效应、上位效应等。</p>
</li>
<li>
<p>支持一步法 (通过 <code>H.mat()</code> 构建H矩阵，但是这里 A 阵需要自己构建，文档中是建议使用 pedigreemm 的 getA 函数)</p>
</li>
<li>
<p>支持多倍体生物的GS</p>
</li>
</ul>
<h1>安装和帮助文档</h1>
<p>首先安装 sommer 包</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span><span class="string">&quot;sommer&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>安装完之后，运行下面命令打开文档</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vignette<span class="punctuation">(</span><span class="string">&quot;v1.sommer.quick.start&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>之后还有 v2 到 v6 的文档</p>
<h1>协方差结构基础</h1>
<p>方差组分的结果有下面几种：</p>
<ul>
<li>
<p>无结构的协方差矩阵（unstructured covariance matrices, US），最常用的方差组分结构。</p>
</li>
<li>
<p>对角化的协方差矩阵（Diagonal covariance matrices, DIAG）, 非对角线元素为 0，如下</p>
<p style=""><img src="https://math.now.sh?from=%5Cboldsymbol%7B%5CSigma%7D%3D%5Cleft%5B%5Cbegin%7Barray%7D%7Brrr%7D%0A%5Csigma_%7Bg_%7Be%201%2C%20e%201%7D%7D%5E2%20%26%200%20%26%200%20%5C%5C%0A%5Cvdots%20%26%20%5Cddots%20%26%20%5Cvdots%20%5C%5C%0A0%20%26%200%20%26%20%5Csigma_%7Bg_%7Be%20i%2C%20e%20i%7D%7D%5E2%0A%5Cend%7Barray%7D%5Cright%5D%0A" /></p></li>
<li>
<p>复合对称协方差矩阵（Compound simmetry covariance structures, CS），如下</p>
<p style=""><img src="https://math.now.sh?from=%5Cboldsymbol%7B%5CSigma%7D%3D%5Cleft%5B%5Cbegin%7Barray%7D%7Brrrr%7D%0A%5Csigma_g%5E2%2B%5Csigma_%7Bg%20e%7D%5E2%20%26%20%5Csigma_g%5E2%20%26%20%5Csigma_g%5E2%20%26%20%5Csigma_g%5E2%20%5C%5C%0A%5Csigma_g%5E2%20%26%20%5Csigma_g%5E2%2B%5Csigma_%7Bg%20e%7D%5E2%20%26%20%5Csigma_g%5E2%20%26%20%5Csigma_g%5E2%20%5C%5C%0A%5Cvdots%20%26%20%5Cvdots%20%26%20%5Cddots%20%26%20%5Cvdots%20%5C%5C%0A%5Csigma_g%5E2%20%26%20%5Csigma_g%5E2%20%26%20%5Csigma_g%5E2%20%26%20%5Csigma_g%5E2%2B%5Csigma_%7Bg%20e%7D%5E2%0A%5Cend%7Barray%7D%5Cright%5D%0A" /></p></li>
<li>
<p>一阶自我回归协方差矩阵（First order autoregressive covariance structures, AR1），如下</p>
<p style=""><img src="https://math.now.sh?from=%5Cboldsymbol%7B%5CSigma%7D%3D%5Csigma%5E2%5Cleft%5B%5Cbegin%7Barray%7D%7Brrrr%7D%0A1%20%26%20%5Crho%20%26%20%5Crho%5E2%20%26%20%5Crho%5E3%20%5C%5C%0A%5Crho%20%26%201%20%26%20%5Crho%20%26%20%5Crho%5E2%20%5C%5C%0A%5Crho%5E2%20%26%20%5Crho%20%26%201%20%26%20%5Crho%20%5C%5C%0A%5Crho%5E3%20%26%20%5Crho%5E2%20%26%20%5Crho%20%26%201%0A%5Cend%7Barray%7D%5Cright%5D%0A" /></p></li>
</ul>
<h1>mmer 函数</h1>
<p>sommer 包中有两个核心的函数 mmec 和 mmer 函数，它们都是利用 AI 算法和 MME 来计算方差组分和估计育种值的。二者区别在于，当需要估计的系数 (coefficients to estimate, c) 小于表型数目（records, r）时，我们调用 mmec 函数；反过来，<strong>当 c &gt; r 时，我们使用 mmer 函数，此时我们使用直接求逆算法更快（对系数矩阵直接求逆）</strong>。</p>
<p>由于一般来说，系数矩阵维度都是超过表型数目的，因此我们一般只会调用 mmer 函数。</p>
<blockquote>
<p>mmer(fixed, random, rcov, data, weights, W, nIters=20, tolParConvLL = 1e-03,<br>
tolParInv = 1e-06, init=NULL, constraints=NULL,method=“NR”, getPEV=TRUE,<br>
naMethodX=“exclude”, naMethodY=“exclude”,returnParam=FALSE,<br>
dateWarning=TRUE,date.warning=TRUE,verbose=TRUE, reshapeOutput=TRUE, stepWeight=NULL,<br>
emWeight=NULL)</p>
</blockquote>
<p>这里我们重点介绍一些常用参数：</p>
<ul>
<li>
<p><code>fixed</code> : 指定性状和固定效应，固定格式为 <code>fixed = 反应变量 ~ 固定因子1 + 固定因子2</code> ，其中 <code>fixed=</code>可以省略。</p>
</li>
<li>
<p><code>random</code> ： 指定随机因子，固定格式为 <code>random = ~ 随机因子1 + 随机因子2</code></p>
</li>
<li>
<p><code>rcov</code>: 指定残差，例如 <code>rcov = ~ units</code></p>
</li>
<li>
<p><code>data</code> :  指定数据集</p>
</li>
<li>
<p><code>nIters</code> ： 最大迭代次数，默认为 20</p>
</li>
<li>
<p><code>tolParConvLL</code> : 对数似然值变化的收敛阈值</p>
</li>
<li>
<p><code>init</code> ：方差组分初始值，默认由软件自己提供。</p>
</li>
<li>
<p><code>mothod</code> ：估计方差组分算法，NR 或 AI</p>
</li>
<li>
<p><code>naMethodX</code>： 自变量是否可以含有缺失值，include （将缺失值填充为中位数?）或 exclude（剔除含有缺失值的行）</p>
</li>
<li>
<p><code>naMethodY</code>： 自变量是否可以含有缺失值，include （将缺失值填充为中位数?）或include2 （只对多性状模型中至少有一个表型不为缺失的行进行填充，应该也是填充为中位数），或 exclude（剔除含有缺失值的行）</p>
</li>
<li>
<p><code>verbose</code> ：TRUE/FALSE， 是否反馈迭代过程</p>
</li>
</ul>
<p>输出结果为一个列表，包括以下内容：</p>
<ul>
<li><code>Vi</code> ：表型的协方差矩阵的逆矩阵</li>
<li><code>P</code> ：投影矩阵</li>
</ul>
<h1>多性状模型</h1>
<h2 id="固定因子">固定因子</h2>
<p>多性状模型固定因子设置如下，就是性状部分改为 cbind(y1,y2) ， 后面和单性状一样。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fixed <span class="operator">=</span> cbind<span class="punctuation">(</span>y1<span class="punctuation">,</span>y2<span class="punctuation">)</span> <span class="operator">~</span> x</span><br></pre></td></tr></table></figure>
<h2 id="随机因子">随机因子</h2>
<p>设置随机因子如下，加入我们需要设置一个无结构化的方差组分的随机因子 re ，则设置如下（unsm(2) 中的2 为性状数目）。</p>
<p><strong>对于残差项，其永远对应着 <code>units</code> 项</strong>。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">random <span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>re<span class="punctuation">,</span> Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rcov<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>units<span class="punctuation">,</span> Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>这里 <code>vsr</code> 就是指定随机效应的方差组分结构的函数，完整参数如下：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsr<span class="punctuation">(</span>...<span class="punctuation">,</span> Gu<span class="operator">=</span><span class="literal">NULL</span><span class="punctuation">,</span> Gti<span class="operator">=</span><span class="literal">NULL</span><span class="punctuation">,</span> Gtc<span class="operator">=</span><span class="literal">NULL</span><span class="punctuation">,</span> reorderGu<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> buildGu<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>
<p><code>Gu</code> ：随机因子的不同水平之间的已知的协方差矩阵（如亲缘关系矩阵，矩阵格式，行名称和列名称改为个体号），默认为单位矩阵，矩阵维度可以大于随机因子水平数目。</p>
</li>
<li>
<p><code>Gti</code> ：方差组分初始值，是一个 t × t 矩阵（t 为性状数目）。</p>
<p><code>Gti</code> 初始值需要经过 scaled，要么使用之前跑的 <code>mmer</code> 函数的 <code>sigma_scaled</code> 结果， 例如</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initialVal <span class="operator">&lt;-</span> mix1<span class="operator">$</span>sigma_scaled<span class="operator">$</span>`u:id`</span><br></pre></td></tr></table></figure>
<p>要么可以通过下面的公式计算。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m = x/var(y)</span><br></pre></td></tr></table></figure>
<p>where <code>x</code> is the desired initial value and <code>y</code> is the response variable.</p>
</li>
<li>
<p><code>Gtc</code> ：方差组分限制，是一个 t × t 矩阵（t 为性状数目），元素含义如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0: not to be estimated</span><br><span class="line">1: estimated and constrained to be positive (i.e. variance component)</span><br><span class="line">2: estimated and unconstrained (can be negative or positive, i.e. covariance component)</span><br><span class="line">3: not to be estimated but fixed (value has to be provided in the Gti argument)</span><br></pre></td></tr></table></figure>
<p>默认就是创建一个无结构的矩阵，即使用 unsm(2) 函数（2为性状数目，创建一个对角线元素为1，非对角线元素为2的矩阵）。也可以使用 <code>diag()</code> 函数指定为对角矩阵（即将非对角线元素设为0，对角线元素为 1）；也可以使用 <code>fixm()</code> 函数指定使用方差组分初始值作为真实值（创建一个元素均为3的矩阵）。</p>
</li>
<li>
<p><code>reorderGu</code> ： TRUE/FALSE ，没看懂</p>
</li>
</ul>
<p>此时的 re 具有以下的方差结构（<strong>即sommer是按照因子排序的</strong>，不是我们一般的按照个体排序）。</p>
<p style=""><img src="https://math.now.sh?from=%5Coperatorname%7Bvar%7D%28u%29%3DT%20%5Cotimes%20A%0A" /></p><p style=""><img src="https://math.now.sh?from=%5Coperatorname%7Bvar%7D%28%5Cmathbf%7Bu%7D%29%3D%5Cleft%5B%5Cbegin%7Barray%7D%7Bll%7D%0A%5Csigma_%7Bg_%7Bt%201%2C%20t%201%7D%7D%5E2%20%26%20%5Csigma_%7Bg_%7Bt%201%2C%20t%202%7D%7D%20%5C%5C%0A%5Csigma_%7Bg_%7Bt%202%2C%20t%201%7D%7D%20%26%20%5Csigma_%7Bg_%7Bt%202%2C%20t%202%7D%7D%5E2%0A%5Cend%7Barray%7D%5Cright%5D%20%5Cotimes%20A%0A" /></p><p>如果存在额外的未知的协方差结构，例如</p>
<p style=""><img src="https://math.now.sh?from=%5Coperatorname%7Bvar%7D%28u%29%3DE%20%5Cotimes%20%5Cldots%20%5Cotimes%20F%20%5Cotimes%20A%0A" /></p><p style=""><img src="https://math.now.sh?from=%5Coperatorname%7Bvar%7D%28%5Cmathbf%7Bu%7D%29%3D%5Cleft%5B%5Cbegin%7Barray%7D%7Blll%7D%0A%5Csigma_%7Bg_%7Be%201%2C%20e%201%7D%7D%5E2%20%26%20%5Csigma_%7Bg_%7Be%201%2C%20e%202%7D%7D%20%26%20%5Csigma_%7Bg_%7Be%201%2C%20e%203%7D%7D%20%5C%5C%0A%5Csigma_%7Bg_%7Be%202%2C%20e%201%7D%7D%20%26%20%5Csigma_%7Bg_%7Be%202%2C%20e%202%7D%7D%5E2%20%26%20%5Csigma_%7Bg_%7Be%202%2C%20e%203%7D%7D%20%5C%5C%0A%5Csigma_%7Bg_%7Be%203%2C%20e%201%7D%7D%20%26%20%5Csigma_%7Bg_%7Be%203%2C%20e%202%7D%7D%20%26%20%5Csigma_%7Bg_%7Be%203%2C%20e%203%7D%7D%5E2%0A%5Cend%7Barray%7D%5Cright%5D%20%5Cotimes%20%5Cldots%20%5Cotimes%5Cleft%5B%5Cbegin%7Barray%7D%7Bcc%7D%0A%5Csigma_%7Bg_%7Bf%201%2C%20f%201%7D%7D%5E2%20%26%20%5Csigma_%7Bg_%7Bf%201%2C%20f%202%7D%7D%20%5C%5C%0A%5Csigma_%7Bg_%7Bf%202%2C%20f%201%7D%7D%20%26%20%5Csigma_%7Bg_%7Bf%202%2C%20f%202%7D%7D%5E2%0A%5Cend%7Barray%7D%5Cright%5D%20%5Cotimes%20A%0A" /></p><p>举个例子，随机因子 id 是嵌套在因子 env 中的，那么按照以前的写法，模型应该写为 <code>random= ~ diag(env):id</code> 或 <code>random= ~ usr(env):id</code> 格式，但是现在我们应该写为</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fixed<span class="operator">=</span> y1<span class="operator">~</span>x</span><br><span class="line">random<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>dsr<span class="punctuation">(</span>env<span class="punctuation">)</span><span class="punctuation">,</span>id<span class="punctuation">)</span> or random<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>usr<span class="punctuation">(</span>env<span class="punctuation">)</span><span class="punctuation">,</span>id<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>这里的 <code>dsr()</code> 和<code>usr()</code>函数分别定义<strong>对角化的协方差结构</strong>和<strong>无结构的协方差结构</strong>。在上面的例子中，假如 env 的因子数目为3，则 <code>dsr(env)</code> 则创建了一个 3×3 的对角矩阵。</p>
<h1>似然比检验</h1>
<p>似然比检验有两个用途：检查某个随机因子的显著性，检查某个特定的方差组分元素的显著性。</p>
<p>第一种方式，假如我们想要检查加入 <code>the effect of a spatial kerne</code> 是否有用，首先我们看不加入的模型</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data<span class="punctuation">(</span>DT_cpdata<span class="punctuation">)</span></span><br><span class="line">DT <span class="operator">&lt;-</span> DT_cpdata</span><br><span class="line">GT <span class="operator">&lt;-</span> GT_cpdata</span><br><span class="line">MP <span class="operator">&lt;-</span> MP_cpdata</span><br><span class="line"><span class="comment">### mimic two fields</span></span><br><span class="line">A <span class="operator">&lt;-</span> A.mat<span class="punctuation">(</span>GT<span class="punctuation">)</span></span><br><span class="line">mix1 <span class="operator">&lt;-</span> mmer<span class="punctuation">(</span>Yield<span class="operator">~</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             random<span class="operator">=</span><span class="operator">~</span>vsr<span class="punctuation">(</span>id<span class="punctuation">,</span> Gu<span class="operator">=</span>A<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">               vsr<span class="punctuation">(</span>Rowf<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">               vsr<span class="punctuation">(</span>Colf<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             rcov<span class="operator">=</span><span class="operator">~</span>vsr<span class="punctuation">(</span>units<span class="punctuation">)</span><span class="punctuation">,</span> nIters<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">             data<span class="operator">=</span>DT<span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>然后我们加入这个因子试试</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mix2 <span class="operator">&lt;-</span> mmer<span class="punctuation">(</span>Yield<span class="operator">~</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             random<span class="operator">=</span><span class="operator">~</span>vsr<span class="punctuation">(</span>id<span class="punctuation">,</span> Gu<span class="operator">=</span>A<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">               vsr<span class="punctuation">(</span>Rowf<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">               vsr<span class="punctuation">(</span>Colf<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">               spl2Da<span class="punctuation">(</span>Row<span class="punctuation">,</span>Col<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             rcov<span class="operator">=</span><span class="operator">~</span>vsr<span class="punctuation">(</span>units<span class="punctuation">)</span><span class="punctuation">,</span> nIters<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">             data<span class="operator">=</span>DT<span class="punctuation">,</span>verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>最后我们进行似然比检验</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lrt <span class="operator">&lt;-</span> anova<span class="punctuation">(</span>mix1<span class="punctuation">,</span> mix2<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> lrt <span class="operator">&lt;-</span> anova<span class="punctuation">(</span>mix1<span class="punctuation">,</span> mix2<span class="punctuation">)</span></span><br><span class="line">Likelihood ratio test <span class="keyword">for</span> mixed models</span><br><span class="line"><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span></span><br><span class="line">     Df      AIC      BIC     loLik   Chisq ChiDf  PrChisq</span><br><span class="line">mod2  <span class="number">8</span> <span class="number">304.5293</span> <span class="number">308.4210</span> <span class="operator">-</span><span class="number">151.2647</span>                       </span><br><span class="line">mod1  <span class="number">7</span> <span class="number">305.1825</span> <span class="number">309.0741</span> <span class="operator">-</span><span class="number">151.5912</span> <span class="number">0.65315</span>     <span class="number">1</span> <span class="number">0.41899</span> </span><br><span class="line"><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span><span class="operator">==</span></span><br><span class="line">Signif. codes<span class="operator">:</span>  <span class="number">0</span> <span class="string">&#x27;***&#x27;</span> <span class="number">0.001</span> <span class="string">&#x27;**&#x27;</span> <span class="number">0.01</span> <span class="string">&#x27;*&#x27;</span> <span class="number">0.05</span> <span class="string">&#x27;.&#x27;</span> <span class="number">0.1</span> <span class="string">&#x27; &#x27;</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>第二种方式，检验一个协方差组分的显著性，例如在多性状模型中，我们想看性状之间的遗传协方差是否显著，同样地，我们可以构建两个不同的模型（加入遗传协方差和不加入遗传协方差）</p>
<p>这里第二个模型的写法看不懂，这里用到的模型和上面不一样，应该用一样的模型才对。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data<span class="punctuation">(</span>DT_example<span class="punctuation">)</span></span><br><span class="line">DT <span class="operator">&lt;-</span> DT_example</span><br><span class="line">DT<span class="operator">$</span>EnvName <span class="operator">&lt;-</span> paste<span class="punctuation">(</span>DT<span class="operator">$</span>Env<span class="punctuation">,</span>DT<span class="operator">$</span>Name<span class="punctuation">)</span></span><br><span class="line">modelBase <span class="operator">&lt;-</span> mmer<span class="punctuation">(</span>cbind<span class="punctuation">(</span>Yield<span class="punctuation">,</span> Weight<span class="punctuation">)</span> <span class="operator">~</span> Env<span class="punctuation">,</span></span><br><span class="line">                  random<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>Name<span class="punctuation">,</span> Gtc<span class="operator">=</span>diag<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># here is diag()</span></span><br><span class="line">                  rcov<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>units<span class="punctuation">,</span> Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> nIters<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                  data<span class="operator">=</span>DT<span class="punctuation">,</span>verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">modelCov <span class="operator">&lt;-</span> mmer<span class="punctuation">(</span>cbind<span class="punctuation">(</span>Yield<span class="punctuation">,</span> Weight<span class="punctuation">)</span> <span class="operator">~</span> Env<span class="punctuation">,</span></span><br><span class="line">                 random<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>usr<span class="punctuation">(</span>Env<span class="punctuation">)</span><span class="punctuation">,</span>Name<span class="punctuation">,</span> Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># here is unsm()</span></span><br><span class="line">                 rcov<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>dsr<span class="punctuation">(</span>Env<span class="punctuation">)</span><span class="punctuation">,</span>units<span class="punctuation">,</span> Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> nIters<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                 data<span class="operator">=</span>DT<span class="punctuation">,</span>verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">lrt <span class="operator">&lt;-</span> anova<span class="punctuation">(</span>modelBase<span class="punctuation">,</span> modelCov<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h1>GBLUP 和 RRBLUP</h1>
<p>GBLUP 示例代码如下，这里 DT 是表型数据框，GT 是基因型数据框（-101格式，行名称需要修改为个体号），使用 sommer 自带的  A.mat() 函数构建G阵</p>
<p>这里表型人为制造了 1/5 的缺失值，然后计算完 GBLUP 值之后，计算 GEBV 和表型的相关，做为准确性。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import sommer</span><br><span class="line">data<span class="punctuation">(</span>DT_wheat<span class="punctuation">)</span></span><br><span class="line">DT <span class="operator">&lt;-</span> DT_wheat</span><br><span class="line">GT <span class="operator">&lt;-</span> GT_wheat</span><br><span class="line">colnames<span class="punctuation">(</span>DT<span class="punctuation">)</span> <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;X&quot;</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span>ncol<span class="punctuation">(</span>DT<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">DT <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>DT<span class="punctuation">)</span>;DT<span class="operator">$</span>id <span class="operator">&lt;-</span> as.factor<span class="punctuation">(</span>rownames<span class="punctuation">(</span>DT<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># select environment 1</span></span><br><span class="line">rownames<span class="punctuation">(</span>GT<span class="punctuation">)</span> <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>DT<span class="punctuation">)</span></span><br><span class="line">K <span class="operator">&lt;-</span> A.mat<span class="punctuation">(</span>GT<span class="punctuation">)</span> <span class="comment"># additive relationship matrix</span></span><br><span class="line"><span class="comment"># GBLUP pedigree-based approach</span></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">12345</span><span class="punctuation">)</span></span><br><span class="line">y.trn <span class="operator">&lt;-</span> DT</span><br><span class="line">vv <span class="operator">&lt;-</span> sample<span class="punctuation">(</span>rownames<span class="punctuation">(</span>DT<span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">round</span><span class="punctuation">(</span>nrow<span class="punctuation">(</span>DT<span class="punctuation">)</span><span class="operator">/</span><span class="number">5</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">y.trn<span class="punctuation">[</span>vv<span class="punctuation">,</span><span class="string">&quot;X1&quot;</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NA</span></span><br><span class="line"><span class="comment">## GBLUP</span></span><br><span class="line">ans <span class="operator">&lt;-</span> mmer<span class="punctuation">(</span>X1<span class="operator">~</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            random<span class="operator">=</span><span class="operator">~</span>vsr<span class="punctuation">(</span>id<span class="punctuation">,</span>Gu<span class="operator">=</span>K<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            rcov<span class="operator">=</span><span class="operator">~</span>units<span class="punctuation">,</span> nIters<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            data<span class="operator">=</span>y.trn<span class="punctuation">,</span>verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span> <span class="comment"># kinship based</span></span><br><span class="line">ans<span class="operator">$</span>U<span class="operator">$</span>`u:id`<span class="operator">$</span>X1 <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>ans<span class="operator">$</span>U<span class="operator">$</span>`u:id`<span class="operator">$</span>X1<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 这一步是将育种值结果的行名称中的id替换为0，但是我发现原本的行名称就没有id，因此不需要运行</span></span><br><span class="line"><span class="comment">#rownames(ans$U$`u:id`$X1) &lt;- gsub(&quot;id&quot;,&quot;&quot;,rownames(ans$U$`u:id`$X1))</span></span><br><span class="line">cor<span class="punctuation">(</span>ans<span class="operator">$</span>U<span class="operator">$</span>`u:id`<span class="operator">$</span>X1<span class="punctuation">[</span>vv<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span>DT<span class="punctuation">[</span>vv<span class="punctuation">,</span><span class="string">&quot;X1&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> use<span class="operator">=</span><span class="string">&quot;complete&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## varcomp</span></span><br><span class="line">summary<span class="punctuation">(</span>ans<span class="punctuation">)</span></span><br><span class="line">summary<span class="punctuation">(</span>ans<span class="punctuation">)</span><span class="operator">$</span>varcomp</span><br><span class="line">vpredict<span class="punctuation">(</span>ans<span class="punctuation">,</span> h2 <span class="operator">~</span>V1<span class="operator">/</span><span class="punctuation">(</span>V1<span class="operator">+</span>V2<span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment"># 遗传力</span></span><br></pre></td></tr></table></figure>
<p>rrBLUP 方法如下，就是将 random 部分做相应的修改，其中 <code>buildGu = FALSE</code> 指定不创建协方差矩阵（因为水平数目太多，并且亲缘关系矩阵只是一个单位矩阵，这样可以节约内存和时间；如果你需要指定特定的亲缘关系矩阵，则不能设置这个）。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## rrBLUP</span></span><br><span class="line">ans2 <span class="operator">&lt;-</span> mmer<span class="punctuation">(</span>X1<span class="operator">~</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             random<span class="operator">=</span><span class="operator">~</span>vsr<span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span>GT<span class="punctuation">)</span><span class="punctuation">,</span> buildGu <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             rcov<span class="operator">=</span><span class="operator">~</span>units<span class="punctuation">,</span> getPEV <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> nIters<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">             data<span class="operator">=</span>y.trn<span class="punctuation">,</span>verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span> <span class="comment"># kinship based</span></span><br><span class="line">u <span class="operator">&lt;-</span> GT <span class="operator">%*%</span> as.matrix<span class="punctuation">(</span>ans2<span class="operator">$</span>U<span class="operator">$</span>`u:GT`<span class="operator">$</span>X1<span class="punctuation">)</span> <span class="comment"># BLUPs for individuals</span></span><br><span class="line">rownames<span class="punctuation">(</span>u<span class="punctuation">)</span> <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>GT<span class="punctuation">)</span></span><br><span class="line">cor<span class="punctuation">(</span>u<span class="punctuation">[</span>vv<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span>DT<span class="punctuation">[</span>vv<span class="punctuation">,</span><span class="string">&quot;X1&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="comment"># same correlation</span></span><br></pre></td></tr></table></figure>
<h1>GBLUP 实操脚本</h1>
<p>如果自己处理基因型数据，那么首先是将芯片号替换为个体号，然后生成 012 格式的基因型数据，然后调用以下脚本</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>sommer<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>data.table<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理基因型，构建 G阵</span></span><br><span class="line">M012 <span class="operator">=</span> fread<span class="punctuation">(</span><span class="string">&quot;renew_chipid.raw&quot;</span><span class="punctuation">,</span> header<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">G <span class="operator">=</span> as.matrix<span class="punctuation">(</span>M012<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">!</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">G <span class="operator">=</span> G <span class="operator">-</span> <span class="number">1</span></span><br><span class="line">rownames<span class="punctuation">(</span>G<span class="punctuation">)</span> <span class="operator">=</span> M012<span class="operator">$</span>IID</span><br><span class="line">G <span class="operator">&lt;-</span> A.mat<span class="punctuation">(</span>G<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>然后处理表型数据，将相应转为因子</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 sommer 进行 GS 计算</span></span><br><span class="line">dd <span class="operator">=</span> read.table<span class="punctuation">(</span><span class="string">&quot;phe_uncode&quot;</span><span class="punctuation">,</span> header<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"><span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span> dd<span class="punctuation">[</span><span class="punctuation">,</span>i<span class="punctuation">]</span> <span class="operator">=</span> as.factor<span class="punctuation">(</span>dd<span class="punctuation">[</span><span class="punctuation">,</span>i<span class="punctuation">]</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>最后调用 sommer 包进行 GBLUP 计算，得到方差组分和育种值</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 双性状模型</span></span><br><span class="line">mod <span class="operator">=</span> mmer<span class="punctuation">(</span>cbind<span class="punctuation">(</span>V4<span class="punctuation">,</span>V5<span class="punctuation">)</span> <span class="operator">~</span> V2<span class="punctuation">,</span> </span><br><span class="line">                random <span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>V1<span class="punctuation">,</span>Gu<span class="operator">=</span>G<span class="punctuation">,</span>Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> vsr<span class="punctuation">(</span>V3<span class="punctuation">,</span>Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                rcov<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>units<span class="punctuation">,</span> Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                data<span class="operator">=</span>dd<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存方差组分</span></span><br><span class="line">write.table<span class="punctuation">(</span>summary<span class="punctuation">(</span>mod<span class="punctuation">)</span><span class="operator">$</span>varcomp<span class="punctuation">,</span> <span class="string">&quot;summary_mmer.txt&quot;</span><span class="punctuation">,</span><span class="built_in">quote</span><span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存育种值</span></span><br><span class="line">mod<span class="operator">$</span>U<span class="operator">$</span>`u:V1`<span class="operator">$</span>V4 <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>mod<span class="operator">$</span>U<span class="operator">$</span>`u:V1`<span class="operator">$</span>V4<span class="punctuation">)</span></span><br><span class="line">mod<span class="operator">$</span>U<span class="operator">$</span>`u:V1`<span class="operator">$</span>V5 <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>mod<span class="operator">$</span>U<span class="operator">$</span>`u:V1`<span class="operator">$</span>V5<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">write.table<span class="punctuation">(</span>mod<span class="operator">$</span>U<span class="operator">$</span>`u:V1`<span class="operator">$</span>V4<span class="punctuation">,</span> <span class="string">&quot;mmer_gblup1.txt&quot;</span><span class="punctuation">,</span><span class="built_in">quote</span><span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span>col.names<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>mod<span class="operator">$</span>U<span class="operator">$</span>`u:V1`<span class="operator">$</span>V5<span class="punctuation">,</span> <span class="string">&quot;mmer_gblup2.txt&quot;</span><span class="punctuation">,</span><span class="built_in">quote</span><span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span>col.names<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h1>显性效应和上位效应</h1>
<p>sommer 包可以通过 <code>D.mat()</code> 和 <code>E.mat()</code> 来构建显性效应和上位效应的亲缘关系矩阵。</p>
<p>这里我们需要先复制两次个体号所在列，创建 idd 和 ide 列，分别做为显性和上位效应指定的列。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 显性效应和上位效应</span></span><br><span class="line">data<span class="punctuation">(</span>DT_cpdata<span class="punctuation">)</span></span><br><span class="line">DT <span class="operator">&lt;-</span> DT_cpdata</span><br><span class="line">GT <span class="operator">&lt;-</span> GT_cpdata</span><br><span class="line">MP <span class="operator">&lt;-</span> MP_cpdata</span><br><span class="line">DT<span class="operator">$</span>idd <span class="operator">&lt;-</span>DT<span class="operator">$</span>id; DT<span class="operator">$</span>ide <span class="operator">&lt;-</span>DT<span class="operator">$</span>id</span><br><span class="line"><span class="comment">### look at the data</span></span><br><span class="line">A <span class="operator">&lt;-</span> A.mat<span class="punctuation">(</span>GT<span class="punctuation">)</span> <span class="comment"># additive relationship matrix</span></span><br><span class="line">D <span class="operator">&lt;-</span> D.mat<span class="punctuation">(</span>GT<span class="punctuation">)</span> <span class="comment"># dominance relationship matrix</span></span><br><span class="line">E <span class="operator">&lt;-</span> E.mat<span class="punctuation">(</span>GT<span class="punctuation">)</span> <span class="comment"># epistatic relationship matrix</span></span><br><span class="line"></span><br><span class="line">ans.ADE <span class="operator">&lt;-</span> mmer<span class="punctuation">(</span>color<span class="operator">~</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                random<span class="operator">=</span><span class="operator">~</span>vsr<span class="punctuation">(</span>id<span class="punctuation">,</span>Gu<span class="operator">=</span>A<span class="punctuation">)</span> <span class="operator">+</span> vsr<span class="punctuation">(</span>idd<span class="punctuation">,</span>Gu<span class="operator">=</span>D<span class="punctuation">)</span><span class="operator">+</span> vsr<span class="punctuation">(</span>ide<span class="punctuation">,</span>Gu<span class="operator">=</span>E<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                rcov<span class="operator">=</span><span class="operator">~</span>units<span class="punctuation">,</span> nIters<span class="operator">=</span><span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">                data<span class="operator">=</span>DT<span class="punctuation">,</span>verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">summary<span class="punctuation">(</span>ans.ADE<span class="punctuation">)</span><span class="operator">$</span>varcomp</span><br><span class="line">vpredict<span class="punctuation">(</span>ans.ADE<span class="punctuation">,</span> h2 <span class="operator">~</span> <span class="punctuation">(</span>V1<span class="punctuation">)</span> <span class="operator">/</span> <span class="punctuation">(</span> V1<span class="operator">+</span>V2<span class="operator">+</span>V3<span class="operator">+</span>V4<span class="punctuation">)</span> <span class="punctuation">)</span> <span class="comment"># narrow sense</span></span><br><span class="line">vpredict<span class="punctuation">(</span>ans.ADE<span class="punctuation">,</span> h2 <span class="operator">~</span> <span class="punctuation">(</span>V1<span class="operator">+</span>V2<span class="operator">+</span>V3<span class="punctuation">)</span> <span class="operator">/</span> <span class="punctuation">(</span> V1<span class="operator">+</span>V2<span class="operator">+</span>V3<span class="operator">+</span>V4<span class="punctuation">)</span> <span class="punctuation">)</span> <span class="comment"># broad-sense</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1>永久环境效应</h1>
<p>类似于显性效应和上位效应，永久环境效应也需要复制 id 列行成一列新列，不然结果会有问题（sommer应该不能指定同一列作为多个因子），举例如下</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单性状重复力模型</span></span><br><span class="line"><span class="comment"># 需要复制id新增一列</span></span><br><span class="line">dd<span class="operator">$</span>id2 <span class="operator">=</span> dd<span class="operator">$</span>V1</span><br><span class="line">mod <span class="operator">=</span> mmer<span class="punctuation">(</span>V4 <span class="operator">~</span> V2<span class="operator">+</span>V3<span class="punctuation">,</span> </span><br><span class="line">                random <span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>V1<span class="punctuation">,</span>Gu<span class="operator">=</span>G<span class="punctuation">,</span>Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> vsr<span class="punctuation">(</span>id2<span class="punctuation">,</span>Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                rcov<span class="operator">=</span> <span class="operator">~</span> vsr<span class="punctuation">(</span>units<span class="punctuation">,</span> Gtc<span class="operator">=</span>unsm<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                data<span class="operator">=</span>dd<span class="punctuation">)</span></span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/R/" rel="tag">R</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" rel="tag">数据分析</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/posts/68187292/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            R包-pedigreemm
          
        </div>
      </a>
    
    
      <a href="/posts/b124d4e/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">gitee简易命令行入门教程</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "yHN3kf7fHt5wvleM2DVoHLdY-gzGzoHsz",
    app_key: "RPIwmdftljIzOtAULwc7JCAp",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "靓仔，看完留个评论再走哇！\n只需要填入昵称和邮箱就可以了",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2019-2023
        <i class="ri-heart-fill heart_icon"></i> Vincere Zhou
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>

    <!-- 与只只在一起天数 -->
	<ul>
		<li><span id="lovetime_span"></span></li>
	</ul>
    <script type="text/javascript">			
        function show_runtime() {
            window.setTimeout("show_runtime()", 1000);
            X = new Date("03/04/2021 22:11:00");
            Y = new Date();
            T = (Y.getTime() - X.getTime());
            M = 24 * 60 * 60 * 1000;
            a = T / M;
            A = Math.floor(a);
            b = (a - A) * 24;
            B = Math.floor(b);
            c = (b - B) * 60;
            C = Math.floor((b - B) * 60);
            D = Math.floor((c - C) * 60);
            lovetime_span.innerHTML = "只只和男朋友在一起了 " + A + "天" + B + "小时" + C + "分" + D + "秒"
        }
        show_runtime();
    </script>

  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/mojie.jpg" alt=""></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯茶吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/weixinpay.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


    
  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300,"hOffset":80,"vOffset":-70},"mobile":{"show":false,"scale":0.5},"log":false});</script></body>

</html>